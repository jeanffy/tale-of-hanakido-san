var t;!function(t){t.Debug01="debug01",t.Grass0="grass0",t.Grass1="grass1",t.Plant="plant",t.Bush="bush",t.Chest="chest",t.Book="book",t.Hero="hero",t.Character="character",t.Objects="objects",t.Overworld="overworld"}(t||(t={}));const e="assets",r=[{id:t.Character,url:`${e}/character.png`},{id:t.Objects,url:`${e}/objects.png`},{id:t.Overworld,url:`${e}/overworld.png`}];var i,s,o;!function(t){t.Debug01="debug01",t.Grass0="grass0",t.Grass1="grass1",t.Bush="bush",t.Chest="chest",t.Book="book",t.Plant="plant",t.PlantOverlay="plant-overlay",t.Hero="hero"}(i||(i={})),function(t){t.Closed="closed",t.Opening="opening",t.Open="open"}(s||(s={})),function(t){t.StillUp="still-up",t.StillDown="still-down",t.StillLeft="still-left",t.StillRight="still-right",t.WalkingUp="walking-up",t.WalkingDown="walking-down",t.WalkingLeft="walking-left",t.WalkingRight="walking-right",t.SwordUp="sword-up",t.SwordDown="sword-down",t.SwordLeft="sword-left",t.SwordRight="sword-right"}(o||(o={}));const a=[{id:i.Grass0,states:[{textureId:t.Overworld,frames:[{bbox:[0,0,47,47]}]}]},{id:i.Grass1,states:[{textureId:t.Overworld,frames:[{bbox:[816,1392,863,1439]}]}]},{id:i.Plant,states:[{textureId:t.Overworld,frames:[{bbox:[1536,105,1573,138],anchor:[0,-51]}]}],hitBox:[9,54,38,77]},{id:i.PlantOverlay,states:[{textureId:t.Overworld,frames:[{bbox:[1536,54,1573,104]}]}]},{id:i.Hero,states:[{label:o.StillUp,textureId:t.Character,frames:[{bbox:[0,207,44,275]}]},{label:o.StillDown,textureId:t.Character,frames:[{bbox:[3,18,47,83]}]},{label:o.StillLeft,textureId:t.Character,frames:[{bbox:[3,306,41,371]}]},{label:o.StillRight,textureId:t.Character,frames:[{bbox:[6,114,44,179]}]},{label:o.WalkingUp,textureId:t.Character,frames:[{bbox:[3,18,47,83]},{bbox:[51,18,95,83]},{bbox:[99,18,143,83]},{bbox:[147,18,191,83]}]},{label:o.WalkingDown,textureId:t.Character,frames:[{bbox:[3,18,47,83]},{bbox:[51,18,95,83]},{bbox:[99,18,143,83]},{bbox:[147,18,191,83]}]},{label:o.WalkingLeft,textureId:t.Character,frames:[{bbox:[3,18,47,83]},{bbox:[51,18,95,83]},{bbox:[99,18,143,83]},{bbox:[147,18,191,83]}]},{label:o.WalkingRight,textureId:t.Character,frames:[{bbox:[3,18,47,83]},{bbox:[51,18,95,83]},{bbox:[99,18,143,83]},{bbox:[147,18,191,83]}]}],hitBox:[3,32,38,59]}];var n;!function(t){t.Chest="chest",t.Hero="hero"}(n||(n={}));const h={layer0:[{spriteId:i.Grass0,x:150,y:250},{spriteId:i.Grass1,x:198,y:250}],layer1:[{spriteId:i.Plant,x:150,y:100},{spriteId:i.Plant,x:195,y:100}],layer2:[{spriteId:i.Hero,type:n.Hero,x:50,y:100}],layer3:[{spriteId:i.PlantOverlay,x:150,y:100},{spriteId:i.PlantOverlay,x:195,y:100}]};class c{targetFps;timer=0;frameCountInOneSecond=0;fps=0;constructor(t){this.targetFps=t.targetFps}shouldRender(t){return this.timer+=t,this.timer>1e3&&(this.fps=this.frameCountInOneSecond,this.frameCountInOneSecond=0,this.timer=0),this.frameCountInOneSecond++,Promise.resolve(!0)}}class l{scene;controlState;frameRateIterator;constructor(t){this.scene=t,this.controlState={up:!1,down:!1,left:!1,right:!1,control:!1,action1:!1,action2:!1},this.frameRateIterator=new c({targetFps:60})}nextFrame(t,e){this.scene.processInputs(e,this.controlState),this.scene.update(e),this.frameRateIterator.shouldRender(e).then((e=>{e&&this.render(t)}))}updateControlState(t){this.controlState.up=t.up??this.controlState.up,this.controlState.down=t.down??this.controlState.down,this.controlState.left=t.left??this.controlState.left,this.controlState.right=t.right??this.controlState.right,this.controlState.control=t.control??this.controlState.control,this.controlState.action1=t.action1??this.controlState.action1,this.controlState.action2=t.action2??this.controlState.action2}render(t){try{this.scene.render(t);const e=`FPS: ${this.frameRateIterator.fps}`;t.writeText(e,5,5,{horizontalAlign:"left",verticalAlign:"top"})}catch(t){console.error(t)}}}var p;!function(t){function e(t,e){return!1}t.rectIntersectsWithRect=function(t,e){return!(t.x>e.x+e.w)&&(!(t.x+t.w<e.x)&&(!(t.y>e.y+e.h)&&!(t.y+t.h<e.y)))},t.rectIntersectsWithCircle=e,t.circleIntersectsWithCircle=function(t,e){const r=e.x-t.x,i=e.y-t.y;return Math.sqrt(r*r+i*i)<t.r+e.r},t.circleIntersectsWithRect=function(t,e){return!1}}(p||(p={}));class d{x;y;w;h;constructor(t,e,r,i){this.x=t,this.y=e,this.w=r,this.h=i}equals(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}moveByVector(t){return new d(this.x+t.x,this.y+t.y,this.w,this.h)}intersectsWithRect(t){return p.rectIntersectsWithRect(this,t)}intersectsWithCircle(t){return p.rectIntersectsWithCircle(this,t)}}class u{id;image;imageBBox;constructor(t,e){this.id=t,this.image=e,this.imageBBox=new d(0,0,e.width,e.height)}getCroppedImage(t){const e=document.createElement("canvas");e.width=t.w,e.height=t.h;e.getContext("2d").drawImage(this.image,-t.x,-t.y);const r=document.createElement("img");return r.src=e.toDataURL(),r}render(t,e,r){e.equals(this.imageBBox)?t.drawImage(this.image,r.x,r.y,this.image.width,this.image.height):t.drawImageCropped(this.image,e.x,e.y,e.w,e.h,r.x,r.y,e.w,e.h)}}class m{textures=new Map;async loadTextures(t){for(const e of t){const t=await new Promise(((t,r)=>{let i=new Image;i.onload=()=>{t(new u(e.id,i))},i.onerror=()=>{r()},i.src=e.url}));this.textures.set(e.id,t)}}getTexture(t){const e=this.textures.get(t);if(void 0===e)throw new Error(`No texture for id '${t}'`);return e}scaleImage(t,e){if(!Number.isInteger(e))throw console.error(`Invalid scale ${e}`),Error();if(1===e)return t;const r=document.createElement("canvas").getContext("2d");if(null===r)throw console.error("Error creating memory canvas"),Error();const i=t.width,s=t.height,o=i*e,a=s*e;r.drawImage(t,0,0,i,s);const n=r.getImageData(0,0,i,s),h=document.createElement("canvas");h.width=o,h.height=a;const c=h.getContext("2d");if(null===c)throw console.error("Error creating memory canvas"),Error();const l=c.createImageData(o,a);let p=0;for(let t=0;t<s;t++){const r=t*i*4,s=r+4*i,o=n.data.slice(r,s);for(let t=0;t<e;t++)for(let t=0;t<o.length;t+=4)for(let r=0;r<e;r++)l.data[p++]=o[t],l.data[p++]=o[t+1],l.data[p++]=o[t+2],l.data[p++]=o[t+3]}c.putImageData(l,0,0);const d=document.createElement("img");return d.src=h.toDataURL(),d}}class x{items;constructor(t){this.items=t}anyItemCollidesWith(t,e,r){for(const i of this.items)if(i.canCollide()&&i.uniqueId!==t.uniqueId&&this.checkCollision(t.sprite,e,i.sprite,i.position,r?.tolerance??0))return i}checkCollision(t,e,r,i,s){if(t.hitBox instanceof d){const o=new d(e.x-(t.hitBoxAnchor?.x??0)+t.hitBox.x-s,e.y-(t.hitBoxAnchor?.y??0)+t.hitBox.y-s,t.hitBox.w+s,t.hitBox.h+s);if(r.hitBox instanceof d){const t=new d(i.x-(r.hitBoxAnchor?.x??0)+r.hitBox.x-s,i.y-(r.hitBoxAnchor?.y??0)+r.hitBox.y-s,r.hitBox.w+s,r.hitBox.h+s);return o.intersectsWithRect(t)}}return!1}}class g{layer0;layer1;layer2;layer3;collider;constructor(t,e,r,i){this.layer0=t,this.layer1=e,this.layer2=r,this.layer3=i,this.collider=new x([...this.layer1,...this.layer2])}processInputs(t,e){this.layer2.forEach((t=>t.processInputs(e,this.collider)))}update(t){this.layer1.forEach((e=>e.update(t,this.collider))),this.layer2.forEach((e=>e.update(t,this.collider)))}render(t){this.layer0.forEach((e=>e.render(t)));[...this.layer1,...this.layer2].sort(((t,e)=>t.position.y+(t.hitBox?.h??0)-(e.position.y+(e.hitBox?.h??0)))).forEach((e=>e.render(t))),this.layer3.sort(((t,e)=>t.position.y-e.position.y)),this.layer3.forEach((e=>e.render(t)))}}class w{x;y;constructor(t,e){this.x=t,this.y=e}moveByVector(t){return new w(this.x+t.x,this.y+t.y)}}class f{x;y;constructor(t,e){this.x=t,this.y=e}normalize(){const t=Math.sqrt(this.x*this.x+this.y*this.y);if(t<=0)throw console.error(`Vector has an invalid magnitude (${this.x}, ${this.y})`),new Error(`Vector has an invalid magnitude (${this.x}, ${this.y})`);return new f(this.x/=t,this.y/=t)}scale(t){return new f(this.x*t,this.y*t)}}class y{params;currentFrame;millisecBeforeNextFrame;reverse=!1;constructor(t){this.params=t,this.currentFrame=0,this.millisecBeforeNextFrame=this.params.delay}get label(){return this.params.label}get bbox(){return this.params.frames[this.currentFrame].boundingBox}get isReversed(){return this.reverse}update(t){const e={loopedAnimation:!1};return this.params.frames.length<=1||(this.millisecBeforeNextFrame-=t,this.millisecBeforeNextFrame<0&&(this.millisecBeforeNextFrame=this.params.delay,this.reverse?(this.currentFrame--,this.currentFrame<0&&(this.currentFrame=this.params.frames.length-1,e.loopedAnimation=!0)):(this.currentFrame++,this.currentFrame>=this.params.frames.length&&(this.currentFrame=0,e.loopedAnimation=!0)))),e}render(t,e){const r=this.params.frames[this.currentFrame],i=e.moveByVector(new f(-r.anchor.x,-r.anchor.y));this.params.texture.render(t,r.boundingBox,i)}}class b{params;currentState;constructor(t){if(this.params=t,t.states.length<1)throw console.error("Sprite states must have at least 1 state"),new Error("Sprite states must have at least 1 state");this.currentState=this.params.states[0]}get boundingBox(){return this.currentState.bbox}get hitBox(){return this.params.hitBox}hasHitBox(){return void 0!==this.params.hitBox}get hitBoxAnchor(){return this.params.hitBoxAnchor}selectState(t,e){if(t===this.currentState.label){const t=e??!1;if(this.currentState.isReversed===t)return}this.currentState=this.params.states[0];const r=this.params.states.find((e=>e.label===t));void 0!==r&&(this.currentState=r)}update(t){return this.currentState.update(t)}render(t,e){this.currentState.render(t,e),this.hitBox instanceof d&&t.strokeRect(e.x-(this.hitBoxAnchor?.x??0)+this.hitBox.x,e.y-(this.hitBoxAnchor?.y??0)+this.hitBox.y,this.hitBox.w,this.hitBox.h,{color:"lightgreen"})}}class S{params;constructor(t){this.params=t}get boundingBox(){return this.params.boundingBox}get anchor(){return this.params.anchor}}class v{spritesData;textureManager;spriteCreator;sprites=new Map;constructor(t,e){this.spritesData=t,this.textureManager=e,this.spriteCreator=new B(this.textureManager)}getSprite(t){const e=this.spritesData.find((e=>e.id===t));if(void 0===e)throw new Error(`No sprite data for id '${t}'`);let r=this.sprites.get(t);return void 0===r&&(r=this.spriteCreator.create(e)),r}}class B{textureManager;constructor(t){this.textureManager=t}create(t){const e=[];for(const r of t.states)e.push(this.createState(r));let r,i;return void 0!==t.hitBox&&(r=new d(t.hitBox[0],t.hitBox[1],t.hitBox[2]-t.hitBox[0]+1,t.hitBox[3]-t.hitBox[1]+1)),void 0!==t.hitBoxAnchor&&(i=new w(t.hitBoxAnchor[0],t.hitBoxAnchor[1])),new b({states:e,hitBox:r,hitBoxAnchor:i})}createState(t){const e=this.textureManager.getTexture(t.textureId),r=[];if(void 0===t.frames){const t={bbox:[e.imageBBox.x,e.imageBBox.y,e.imageBBox.x+e.imageBBox.w-1,e.imageBBox.y+e.imageBBox.h-1]};r.push(this.createFrame(t,e))}else for(const i of t.frames)r.push(this.createFrame(i,e));return new y({label:t.label,texture:e,delay:t.delay??100,frames:r})}createFrame(t,e){let r,i;return r=void 0!==t.bbox?new d(t.bbox[0],t.bbox[1],t.bbox[2]-t.bbox[0]+1,t.bbox[3]-t.bbox[1]+1):e.imageBBox,i=void 0!==t.anchor?new w(t.anchor[0],t.anchor[1]):new w(0,0),new S({boundingBox:r,anchor:i})}}const k=500,I=500;class D{canvas;drawContext;lastTimestamp;_game;animationRunning=!0;constructor(t,e){this.canvas=t,this.drawContext=e}get game(){return this._game}get isAnimationRunning(){return this.animationRunning}async start(t,e,r){this.canvas.width=k,this.canvas.height=I;const i=new m;await i.loadTextures(t);const s=new v(e,i),o=new g(r.layer0.map((t=>this.createSceneItem(s,t))),r.layer1.map((t=>this.createSceneItem(s,t))),r.layer2.map((t=>this.createSceneItem(s,t))),r.layer3.map((t=>this.createSceneItem(s,t))));this._game=new l(o),this.setupControls(),window.requestAnimationFrame(this.gameLoop.bind(this))}enableAnimation(t){this.animationRunning=t,this.animationRunning&&window.requestAnimationFrame(this.gameLoop.bind(this))}goToNextFrame(t){this.drawBackground(),this._game.nextFrame(this.drawContext,t),this._game.updateControlState({action1:!1,action2:!1})}gameLoop(t){this.lastTimestamp=this.lastTimestamp??t;const e=t-this.lastTimestamp;this.lastTimestamp=t,this.goToNextFrame(e),this.animationRunning&&window.requestAnimationFrame(this.gameLoop.bind(this))}drawBackground(){this.drawContext.fillRect(0,0,k,I,{color:"#999"});for(let t=50;t<k;t+=50)this.drawContext.strokeRect(t,0,50,k,{color:"black"});for(let t=25;t<k;t+=25)this.drawContext.strokeRect(t,0,25,k,{color:"#888"});for(let t=50;t<I;t+=50)this.drawContext.strokeRect(0,t,I,50,{color:"black"});for(let t=25;t<I;t+=25)this.drawContext.strokeRect(0,t,I,25,{color:"#888"})}setupControls(){window.addEventListener("keydown",(t=>{switch(t.code.toLowerCase()){case"arrowup":this.game.updateControlState({up:!0}),t.preventDefault();break;case"arrowdown":this.game.updateControlState({down:!0}),t.preventDefault();break;case"arrowleft":this.game.updateControlState({left:!0}),t.preventDefault();break;case"arrowright":this.game.updateControlState({right:!0}),t.preventDefault();break;case"keyz":this.game.updateControlState({control:!0}),t.preventDefault()}})),window.addEventListener("keyup",(t=>{switch(t.code.toLowerCase()){case"arrowup":this.game.updateControlState({up:!1}),t.preventDefault();break;case"arrowdown":this.game.updateControlState({down:!1}),t.preventDefault();break;case"arrowleft":this.game.updateControlState({left:!1}),t.preventDefault();break;case"arrowright":this.game.updateControlState({right:!1}),t.preventDefault();break;case"keyz":this.game.updateControlState({control:!1}),t.preventDefault();break;case"keyx":this.game.updateControlState({action1:!0}),t.preventDefault();break;case"keyc":this.game.updateControlState({action2:!0}),t.preventDefault()}}))}}class C{_uniqueId;_sprite;_position;constructor(t){this._uniqueId=btoa(""+99999*Math.random()),this._sprite=t.sprite,this._position=new w(t.x,t.y)}canCollide(){return this._sprite.hasHitBox()}get uniqueId(){return this._uniqueId}get sprite(){return this._sprite}get position(){return this._position}get bbox(){return this._sprite.boundingBox}get hitBox(){return this._sprite.hitBox}processInputs(t,e){}update(t,e){this._sprite.update(t).loopedAnimation&&this.spriteAnimationLooped()}spriteAnimationLooped(){}render(t){this._sprite.render(t,this._position)}}class R extends C{isOpen=!1;constructor(t){super(t),this._sprite.selectState(s.Closed)}open(){this.isOpen?(this._sprite.selectState(s.Opening,!0),this.isOpen=!1):(this._sprite.selectState(s.Opening),this.isOpen=!0)}update(t,e){super.update(t,e)}spriteAnimationLooped(){this._sprite.selectState(this.isOpen?s.Open:s.Closed)}}var W;!function(t){t[t.Up=0]="Up",t[t.Down=1]="Down",t[t.Left=2]="Left",t[t.Right=3]="Right"}(W||(W={}));var A;!function(t){t[t.Still=0]="Still",t[t.UsingSword=1]="UsingSword",t[t.Walking=2]="Walking"}(A||(A={}));class L extends C{movingDirectionX;movingDirectionY;primaryDirection;spriteState;previousState;speed=.1;get state(){switch(this.spriteState){case o.StillUp:case o.StillDown:case o.StillLeft:case o.StillRight:return A.Still;case o.WalkingUp:case o.WalkingDown:case o.WalkingLeft:case o.WalkingRight:return A.Walking;case o.SwordUp:case o.SwordDown:case o.SwordLeft:case o.SwordRight:return A.UsingSword}}constructor(t){super(t),this.spriteState=o.StillDown,this.previousState=this.spriteState,this.movingDirectionX=0,this.movingDirectionY=0}processInputs(t,e){if(super.processInputs(t,e),this.state!==A.UsingSword){if(this.movingDirectionX=0,t.left?(this.movingDirectionX=-1,this.spriteState=o.WalkingLeft,this.primaryDirection!==W.Up&&this.primaryDirection!==W.Down&&(this.primaryDirection=W.Left)):t.right&&(this.movingDirectionX=1,this.spriteState=o.WalkingRight,this.primaryDirection!==W.Up&&this.primaryDirection!==W.Down&&(this.primaryDirection=W.Right)),this.movingDirectionY=0,t.up?(this.movingDirectionY=-1,this.spriteState=o.WalkingUp,this.primaryDirection!==W.Left&&this.primaryDirection!==W.Right&&(this.primaryDirection=W.Up)):t.down&&(this.movingDirectionY=1,this.spriteState=o.WalkingDown,this.primaryDirection!==W.Left&&this.primaryDirection!==W.Right&&(this.primaryDirection=W.Down)),this.state===A.Still){switch(this.primaryDirection){case W.Up:this.spriteState=o.StillUp;break;case W.Down:this.spriteState=o.StillDown;break;case W.Left:this.spriteState=o.StillLeft;break;case W.Right:this.spriteState=o.StillRight}this.primaryDirection=void 0}if(t.action2)switch(this.previousState=this.spriteState,this.primaryDirection){case W.Up:this.spriteState=o.SwordUp;break;case W.Down:this.spriteState=o.SwordDown;break;case W.Left:this.spriteState=o.SwordLeft;break;case W.Right:this.spriteState=o.SwordRight}if(this._sprite.selectState(this.spriteState),this.speed=t.control?.2:.1,t.action1){const t=e.anyItemCollidesWith(this,this._position,{tolerance:5});if(void 0!==t&&t instanceof R){t.open()}}}}update(t,e){switch(super.update(t,e),this.spriteState){case o.WalkingUp:case o.WalkingDown:case o.WalkingLeft:case o.WalkingRight:this.handleWalk(t,new f(this.movingDirectionX,0),e),this.handleWalk(t,new f(0,this.movingDirectionY),e)}}spriteAnimationLooped(){this.state===A.UsingSword&&(this._sprite.selectState(this.previousState),this.spriteState=this.previousState)}render(t){super.render(t)}handleWalk(t,e,r){const i=e.scale(this.speed*t),s=this._position.moveByVector(i);r.anyItemCollidesWith(this,s)||(this._position=this._position.moveByVector(i))}}const E=document.getElementById("canvas")??void 0;if(void 0===E)throw console.error("no canvas div"),new Error("no canvas div");const F=E.getContext("2d")??void 0;if(void 0===F)throw console.error("no context in canvas"),new Error("no context in canvas");const _=new class{context;constructor(t){this.context=t}strokeRect(t,e,r,i,s){this.context.save(),void 0!==s?.width&&(this.context.lineWidth=s.width),void 0!==s?.color&&(this.context.strokeStyle=s.color),this.context.strokeRect(t,e,r,i),this.context.restore()}fillRect(t,e,r,i,s){this.context.save(),void 0!==s?.color&&(this.context.fillStyle=s.color),this.context.fillRect(t,e,r,i),this.context.restore()}drawImage(t,e,r,i,s){this.context.save(),this.context.drawImage(t,e,r,i,s),this.context.restore()}drawImageCropped(t,e,r,i,s,o,a,n,h){this.context.save(),this.context.drawImage(t,e,r,i,s,o,a,n,h),this.context.restore()}writeText(t,e,r,i){if(this.context.save(),void 0!==i?.horizontalAlign)switch(i.horizontalAlign){case"left":this.context.textAlign="left";break;case"center":this.context.textAlign="center";break;case"right":this.context.textAlign="right"}if(void 0!==i?.verticalAlign)switch(i.verticalAlign){case"top":this.context.textBaseline="top";break;case"center":this.context.textBaseline="middle";break;case"bottom":this.context.textBaseline="bottom"}this.context.fillText(t,e,r),this.context.restore()}}(F),U=new class extends D{createSceneItem(t,e){const r=t.getSprite(e.spriteId);if(void 0!==e.type)switch(e.type){case n.Chest:return new R({sprite:r,x:e.x,y:e.y});case n.Hero:return new L({sprite:r,x:e.x,y:e.y});default:throw console.error(`Unhandled item type '${e.type}' at (x,y) = (${e.x},${e.y})`),new Error}return new C({sprite:r,x:e.x,y:e.y})}}(E,_),O=new class{app;stopButton=document.getElementById("ui-btn-stop");startButton=document.getElementById("ui-btn-start");stepButton=document.getElementById("ui-btn-step");constructor(t){this.app=t,this.update()}update(){this.stopButton.style.display=this.app.isAnimationRunning?"unset":"none",this.startButton.style.display=this.app.isAnimationRunning?"none":"unset"}}(U);O.stopButton.addEventListener("click",(t=>{U.enableAnimation(!1),O.update()})),O.startButton.addEventListener("click",(t=>{U.enableAnimation(!0),O.update()})),O.stepButton.addEventListener("click",(t=>{U.goToNextFrame(13),O.update()})),await U.start(r,a,h);
//# sourceMappingURL=index.js.map
