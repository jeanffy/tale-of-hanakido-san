var m=Object.defineProperty;var u=(r,e,t)=>e in r?m(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var s=(r,e,t)=>(u(r,typeof e!="symbol"?e+"":e,t),t);import{d as c,r as d,o as w,c as f,a as g,b as M}from"./index-nqg_puVK.js";class H{constructor(){s(this,"zoom",2)}}var a=(r=>(r[r.Up=0]="Up",r[r.Down=1]="Down",r[r.Left=2]="Left",r[r.Right=3]="Right",r))(a||{}),o=(r=>(r.Grass="grass",r.HeroMoveUp0="hero-move-up-0",r.HeroMoveUp1="hero-move-up-1",r.HeroMoveUp2="hero-move-up-2",r.HeroMoveUp3="hero-move-up-3",r.HeroMoveDown0="hero-move-down-0",r.HeroMoveDown1="hero-move-down-1",r.HeroMoveDown2="hero-move-down-2",r.HeroMoveDown3="hero-move-down-3",r.HeroMoveLeft0="hero-move-left-0",r.HeroMoveLeft1="hero-move-left-1",r.HeroMoveLeft2="hero-move-left-2",r.HeroMoveLeft3="hero-move-left-3",r.HeroMoveRight0="hero-move-right-0",r.HeroMoveRight1="hero-move-right-1",r.HeroMoveRight2="hero-move-right-2",r.HeroMoveRight3="hero-move-right-3",r))(o||{});const S=20,D=20,l=2;class k{constructor(e,t,i,h){s(this,"hero");s(this,"lastRender");s(this,"controlState");this.factory=e,this.environment=t,this.spriteManager=i,this.drawContext=h,this.hero=this.factory.getHero(),console.log(this.hero),this.controlState={up:!1,down:!1,left:!1,right:!1}}async loop(e){this.lastRender===void 0&&(this.lastRender=e);const t=e-this.lastRender,i=Date.now();this.processInputs(t),this.render(t);const n=1e3/60;return i+n-Date.now()>0?new Promise(v=>setTimeout(v,i+16-Date.now())):Promise.resolve()}updateControls(e){this.controlState.up=e.up??this.controlState.up,this.controlState.down=e.down??this.controlState.down,this.controlState.left=e.left??this.controlState.left,this.controlState.right=e.right??this.controlState.right}processInputs(e){let t=!1;this.controlState.up&&(this.hero.move(a.Up),t=!0),this.controlState.down&&(this.hero.move(a.Down),t=!0),this.controlState.left&&(this.hero.move(a.Left),t=!0),this.controlState.right&&(this.hero.move(a.Right),t=!0),t||this.hero.stop()}render(e){try{const t=this.spriteManager.getSprite(o.Grass);for(let i=0;i<S;i++)for(let h=0;h<D;h++){const n=t.element.width*l,p=t.element.height*l;this.drawContext.drawImage(t.element,i*n,h*p,n,p)}this.hero.render(e)}catch(t){console.error(t)}}}class x{constructor(e,t){this.x=e,this.y=t}}class C{constructor(e){s(this,"index",0);s(this,"numberOfSprites");s(this,"frameSkip");s(this,"skippedFrames",0);this.numberOfSprites=e.numberOfSprites,this.frameSkip=e.frameSkip}reset(){this.index=0}getSpriteIndex(){return this.skippedFrames++,this.skippedFrames>this.frameSkip&&(this.skippedFrames=0,this.index++,this.index>this.numberOfSprites-1&&(this.index=0)),this.index}}class R{constructor(e,t,i){s(this,"runningUpSprites",[]);s(this,"runningDownSprites",[]);s(this,"runningLeftSprites",[]);s(this,"runningRightSprites",[]);s(this,"animationIterator",new C({frameSkip:5,numberOfSprites:4}));s(this,"position",new x(0,0));s(this,"isMoving",!1);s(this,"movingDirection",a.Down);s(this,"speed",2.5);this.environment=e,this.spriteManager=t,this.drawContext=i,this.runningUpSprites=[this.spriteManager.getSprite(o.HeroMoveUp0),this.spriteManager.getSprite(o.HeroMoveUp1),this.spriteManager.getSprite(o.HeroMoveUp2),this.spriteManager.getSprite(o.HeroMoveUp3)],this.runningDownSprites=[this.spriteManager.getSprite(o.HeroMoveDown0),this.spriteManager.getSprite(o.HeroMoveDown1),this.spriteManager.getSprite(o.HeroMoveDown2),this.spriteManager.getSprite(o.HeroMoveDown3)],this.runningLeftSprites=[this.spriteManager.getSprite(o.HeroMoveLeft0),this.spriteManager.getSprite(o.HeroMoveLeft1),this.spriteManager.getSprite(o.HeroMoveLeft2),this.spriteManager.getSprite(o.HeroMoveLeft3)],this.runningRightSprites=[this.spriteManager.getSprite(o.HeroMoveRight0),this.spriteManager.getSprite(o.HeroMoveRight1),this.spriteManager.getSprite(o.HeroMoveRight2),this.spriteManager.getSprite(o.HeroMoveRight3)]}move(e){switch(this.movingDirection=e,this.isMoving=!0,e){case a.Up:this.position.y-=this.speed;break;case a.Down:this.position.y+=this.speed;break;case a.Left:this.position.x-=this.speed;break;case a.Right:this.position.x+=this.speed;break}}stop(){this.isMoving=!1}render(e){let t;const i=this.isMoving?this.animationIterator.getSpriteIndex():0;switch(this.movingDirection){case a.Up:t=this.runningUpSprites[i];break;case a.Down:t=this.runningDownSprites[i];break;case a.Left:t=this.runningLeftSprites[i];break;case a.Right:t=this.runningRightSprites[i];break}const h=t.element.width*this.environment.zoom,n=t.element.height*this.environment.zoom;this.drawContext.drawImage(t.element,this.position.x,this.position.y,h,n)}}class L{constructor(){s(this,"sprites",[])}async loadSprites(e){this.sprites=await Promise.all(e.map(t=>new Promise((i,h)=>{const n=new Image;n.onload=()=>{i({id:t.id,element:n})},n.onerror=()=>{h()},n.src=t.url})))}getSprite(e){const t=this.sprites.find(i=>i.id===e);if(t===void 0)throw new Error(`No sprite for id '${e}'`);return t}}class U{constructor(){s(this,"drawContext");s(this,"environment");s(this,"spriteManager");s(this,"game");s(this,"hero")}setDrawContext(e){this.drawContext=e}getDrawContext(){return this.drawContext}getEnvironment(){return this.environment===void 0&&(this.environment=new H),this.environment}getSpriteManager(){return this.spriteManager===void 0&&(this.spriteManager=new L),this.spriteManager}getGame(){return this.game===void 0&&(this.game=new k(this,this.getEnvironment(),this.getSpriteManager(),this.getDrawContext())),this.game}getHero(){return this.hero===void 0&&(this.hero=new R(this.getEnvironment(),this.getSpriteManager(),this.getDrawContext())),this.hero}}const b=[{id:o.Grass,url:"grass.jpg"},{id:o.HeroMoveUp0,url:"hero-move-up-0.png"},{id:o.HeroMoveUp1,url:"hero-move-up-1.png"},{id:o.HeroMoveUp2,url:"hero-move-up-2.png"},{id:o.HeroMoveUp3,url:"hero-move-up-3.png"},{id:o.HeroMoveDown0,url:"hero-move-down-0.png"},{id:o.HeroMoveDown1,url:"hero-move-down-1.png"},{id:o.HeroMoveDown2,url:"hero-move-down-2.png"},{id:o.HeroMoveDown3,url:"hero-move-down-3.png"},{id:o.HeroMoveLeft0,url:"hero-move-left-0.png"},{id:o.HeroMoveLeft1,url:"hero-move-left-1.png"},{id:o.HeroMoveLeft2,url:"hero-move-left-2.png"},{id:o.HeroMoveLeft3,url:"hero-move-left-3.png"},{id:o.HeroMoveRight0,url:"hero-move-right-0.png"},{id:o.HeroMoveRight1,url:"hero-move-right-1.png"},{id:o.HeroMoveRight2,url:"hero-move-right-2.png"},{id:o.HeroMoveRight3,url:"hero-move-right-3.png"}],_={id:"game"},y=500,E=500,P=c({__name:"HomeView",setup(r){const e=d(),t=new U;let i;w(async()=>{if(e.value===void 0)return;e.value.width=y,e.value.height=E;const n=e.value.getContext("2d");if(n===null){console.log("no context");return}t.setDrawContext(n),await t.getSpriteManager().loadSprites(b),window.requestAnimationFrame(h)});function h(n){i=t.getGame(),i.loop(n).then(()=>{window.requestAnimationFrame(h)})}return window.addEventListener("keydown",n=>{switch(n.code){case"ArrowUp":i.updateControls({up:!0}),n.preventDefault();break;case"ArrowDown":i.updateControls({down:!0}),n.preventDefault();break;case"ArrowLeft":i.updateControls({left:!0}),n.preventDefault();break;case"ArrowRight":i.updateControls({right:!0}),n.preventDefault();break}}),window.addEventListener("keyup",n=>{switch(n.code){case"ArrowUp":i.updateControls({up:!1}),n.preventDefault();break;case"ArrowDown":i.updateControls({down:!1}),n.preventDefault();break;case"ArrowLeft":i.updateControls({left:!1}),n.preventDefault();break;case"ArrowRight":i.updateControls({right:!1}),n.preventDefault();break}}),(n,p)=>(M(),f("main",null,[g("div",_,[g("canvas",{ref_key:"canvas",ref:e},null,512)])]))}});export{P as default};
